var VK = require('vksdk');
var TelegramBot = require('node-telegram-bot-api');
var config = require('./config.js');

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
var vk = new VK({
   'appId'     : config.vk_appId,
   'appSecret' : config.vk_secret,
   'language'  : 'ru'
});

// –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å "–ø–µ—Ä–≤—É—é" –∑–∞–ø–∏—Å—å (0 - —Å–µ–π—á–∞—Å).
// –≠—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–∞–∂–¥–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∏–∂–µ...
var hours = 0;

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω VK API
vk.setToken(config.vk_token);

// –í–∫–ª—é—á–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–æ–∫–µ–Ω–æ–º
vk.setSecureRequests(true);

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –∏ –≤–∫–ª—é—á–∞–µ–º –ø—É–ª–ª-–∑–∞–ø—Ä–æ—Å—ã
var bot = new TelegramBot(config.tg_token, {polling: true});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –≥—Ä—É–ø–ø—ã –∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–ø–∏—Å–∏ (–ü—Ä–∏–º–µ—Ä: -20629724_971554)
function getWallId(url){
	return url.replace(/\s*[a-zA-Z\/\/:\.]*vk.com\/wall/,'');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è —Ä–∞–Ω–¥–æ–º–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏.
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// –û—Ç–ª–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π hours (—á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å).
// –ö –ø—Ä–∏–º–µ—Ä—É, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É: "/plus 5", —Ç–æ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ +5 —á–∞—Å–æ–≤.
bot.onText(/\/plus (.+)/, function (msg, match) {
	bot.sendMessage(msg.from.id, '–î–æ–±–∞–≤–∏–ª +'+match[1]+' —á–∞—Å–∞! –ë—ã–ª–æ '+hours+' —á–∞—Å–æ–≤.');
	hours += match[1];
});

// –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –≤–∏–¥–∞: https://vk.com/wall-20629724_971554
bot.onText(/\s*[a-zA-Z\/\/:\.]*vk.com\/wall(.+)$/, function (msg, match) {

	// –ü–æ–ª—É—á–∞–µ–º ID –≥—Ä—É–ø–ø—ã –∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–ø–∏—Å–∏ (–ü—Ä–∏–º–µ—Ä: -20629724_971554)
	var wall = getWallId(match[1]);

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ VK API, –Ω–∞ –ø—Ä–∏—Å–ª–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏. (–ß–∏—Ç–∞–π—Ç–µ –¥–æ–∫. VK API)
	vk.request('wall.getById', {'posts' : wall, copy_history_depth: '1'}, function(data) {

		// –ü–∏—Ö–∞–µ–º JSON —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é post
		var post = data.response[0];

		// –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
		var attachments = [];

		// –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
		for (var i = 0; i < post.attachments.length; i++){
			oid = wall[0];
			if (post.attachments[i][post.attachments[i].type].owner_id!=wall[0]) oid = post.attachments[i][post.attachments[i].type].owner_id;
			attachments.push(post.attachments[i].type+oid+'_'+post.attachments[i][post.attachments[i].type].id);
		}

		// –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º VK API –¥–ª—è attachments
		attachments = attachments.join(',');

		// –û—á–∏—â–∞–µ–º –æ—Ç —Ö—ç—à—Ç–µ–≥–æ–≤
		if (post.text.indexOf('#')>=0)
			post.text = post.text.replace(/\#(.*?)\@(\w[a-zA-Z0-9]{1,})(\s,)?/g,'');

		// –°–æ–∑–¥–∞–µ–º unix-timestamp –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø–∏—Å–∏ –ø–æ —Ç–∞–π–º–µ—Ä—É
		// –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å, —Ç–æ –ø–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –≤ unix-timestamp –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º –∫ –Ω–µ–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π hours (3600 - –æ–¥–∏–Ω —á–∞—Å)
		var time = hours > 0 ? Math.floor(Date.now() / 1000) + ( parseFloat(hours) * 3600 ) : 0;

		// –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ü–µ —Ç—ç–≥(–∏)
		var tags = '#tag1';

		// –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å–æ –≤—Å–µ–º–∏ –≤–±–∏—Ç—ã–≤–∞–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ VK API
		var params = {'owner_id':config.group_id, 'message' : post.text.trim()+'\n\r\n\r'+tags, 'attachments': attachments};

		// –ï—Å–ª–∏ > 0 (–Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å), —Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏
		if (time) params.publish_date = time;

		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ VK API –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏.
		vk.request('wall.post', params, function(data){
			bot.sendMessage(msg.from.id, '–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ\nüì¢ –°—Å—ã–ª–∫–∞: https://vk.com/wall-'+config.group_id+'_'+data.response.post_id);
			hours += getRandomInt(2,5); // –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 2 –¥–æ 5
		});

	});

});
